<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Heimautomatisierung mit iBeacons</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="bower_components/normalize-css/normalize.css">
    <link rel="stylesheet" href="style.css">
    <script src="bower_components/jquery/jquery.min.js"></script>
    <script src="script.js"></script>
</head>
<body>

<div id="front">
<p>
ZHAW Zürcher Hochschule für Angewandte Wissenschaften<br/>
Bachelorstudium Informatik<br/>
Semesterarbeit<br/>
Betreuungsperson: Peter Egli
</p>
<h1>Heimautomatisierung mit iBeacons</h1>
<p class="logo">
<img src="images/logo.png" width="500" height="500" alt="" />
</p>
<p>
Fabian Vogler, <a href="mailto:fabian.vogler@gmail.com">fabian.vogler@gmail.com</a><br/>
<span class="version">18. April 2014, Version 0.2</span>
</p>
</div>

<div class="impress chapter">
<p>
Diese Arbeit entstand im Rahmen der Semesterarbeit an der Zürcher Hochschule 
für Angewandte Wissenschaften (ZHAW) in Zürich.
</p>

<p>
Dieses Dokument wurde in HTML geschrieben und mit Hilfe von 
<a href="http://www.princexml.com/">Prince XML</a> in ein PDF-Dokument 
umgewandelt. Die verwendeten Schriftart ist <em>Helvetica Neue</em>, entwickelt 
von D.&nbsp;Stempel&nbsp;AG und basierend auf <em>Helvetica</em> von Max 
Miedinger.
</p>
</div>

<div class="chapter">
<h2 class="nonr">Inhaltsverzeichnis</h2>
<ol id="toc"></ol>
</div>

<div class="chapter">
<h2>Einleitung</h2>

<h3>Ausgangslage</h3>
<p>
Heimautomatisierung (engl. Home Automation) bezeichnet die intelligente 
Verknüpfung von Sensoren und anderen technischen Geräten innerhalb der eigenen 
Wohnräume zur Steigerung des Wohnkomforts. Effizientere Technik und 
verbraucherorientierte Produkte haben dies in den letzten Jahren auch für 
normale Konsumenten realisierbar gemacht.
</p>
<p>
Apple hat in der neusten Version seines mobilen Betriebssystems, iOS 7, eine 
neue Möglichkeit zur Lokalisierung des Benutzers in geschlossenen Räumen 
hinzugefügt. Die Technik basiert auf Bluetooth Low Energy, trägt den Namen 
iBeacon und kann verwendet werden, um das Betreten oder Verlassen eines Raums 
zu registrieren. Eine Dokumentation des Protokolls wurde von Apple angekündigt,
war jedoch zu Beginn des Projekts noch nicht veröffentlicht. Am Ende des 
Projekts existierte zwar eine Dokumentation zum iBeacon-Format, diese war aber
nur zertifizierten Herstellern zugänglich.
</p>
<p>
Die Verwendung von bestehenden Geräten, wie Smartphones, ist für die 
Heim&shy;automatisierung interessant, da diese vielfältige Möglichkeiten bieten und 
nicht separat angeschafft werden müssen. Eine optimale Ergänzung dazu stellt 
die Philips hue dar. Es handelt sich dabei um LED-Lampe in Form einer Glühbirne, 
welche über eine API verfügt und so gezielt gesteuert werden kann. Zu dieser 
LED-Lampe existierte auch eine offizielle iPhone-App, welche bereits eine 
Steuerung der Beleuchtung über Geo-Location (Wifi, GPS) anbietet. Einige 
Versuche zeigten jedoch, dass dies eher schlecht funktioniert, da die Ortung 
besonders in Gebäuden nicht zuverlässig funktioniert (Lichter gehen aus und 
an während sich die Person am gleichen Ort aufhält).
</p>
<p>
<a href="#ref-chipolo" class="ref">Chipolo</a> ist ein 
Schlüsselanhänger, welcher Bluetooth verwendet, um einen Alarm auszulösen, sobald 
man sich vom iPhone entfernt. Bei dessen Benutzung wurde jedoch beobachtet, dass 
dies eher unzuverlässig funktioniert. Ohne eine detailierte Analyse oder 
Kentnisse über die genaue Funktionsweise, ist es jedoch schwierig zu beurteilen, 
wo die Problemursache liegt. Es führt aber zur Vermutung, dass die Ortung mit 
iBeacons zu ungenau für die Steuerung der Beleuchtung von Räumen ist.
</p>


<h3>Ziele der Arbeit</h3>
<p>
Im Rahmen dieser Semesterarbeit soll analysiert werden, wie die neuen 
Funktionen von iOS&nbsp;7 optimal verwendet werden können, um eine einfache 
Heimautomatisierung zusammen mit der Philips hue zu ermöglichen. Es soll eine 
zentrale Web-Applikation entwickelt werden, welche die Bewegungen eines 
Benutzers innerhalb der eigenen Wohnräume speichert und die Beleuchtung der 
Räume entsprechend steuert. Der Standort des Benutzers wird dabei von einer 
iPhone-App ermittelt und an die Web-Applikation gemeldet.
</p>

<h3>Aufgabenstellung</h3>
<p>
Im Rahmen dieser Semesterarbeit werden vom Studenten folgende Aufgaben ausgeführt:
</p>
<ol>
<li>Analyse der Funktionalitäten von iBeacon.</li>
<li>Untersuchung des auf Bluetooth Low Energy basierenden Protokolls von iBeacon.</li>
<li>Anforderungsdokumentation für die Automatisierung der Beleuchtung einer Wohnung.</li>
<li>Konzeption und Design des Software-Prototyps zur Umsetzung der dokumentierten Anforderungen.</li>
<li>Implementation eines Prototyps bestehend aus einer iPhone-App zur Lokalisierung des Benutzers und einer Web-Applikation zur Überwachung und Steuerung der Beleuchtung.</li>
<li>Verifikation des Software-Prototyps in einem Feldversuch und Analyse der Ergebnisse.</li>
<li>Demonstration des Software-Prototyps.</li>
</ol>

<h3 class="break">Projektablauf</h3>

<p>
Das folgende Gantt-Diagramm gibt einen Überblick über den effektiven Ablauf des 
Projekts und dessen wichtigsten Meilensteine.
</p>

<figure id="figure-gantt">
<table>
    <colgroup>
        <col width="160" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
        <col width="25" />
    </colgroup>
    <thead>
        <tr>
            <th>&#160;</th>
            <th colspan="3">November</th>
            <th colspan="3">Dezember</th>
            <th colspan="3">Januar</th>
            <th colspan="3">Februar</th>
            <th colspan="3">März</th>
            <th colspan="3">April</th>
            <th colspan="3">Mai</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Kick-Off</td>
            <td>&#160;</td>
            <td colspan="4" style="border-left: 0;">◆ 13.11.13</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
        </tr>
        <tr>
            <td>Analyse iBeacons</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td colspan="4" style="background-color: #e8f0f8;">&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
        </tr>
        <tr>
            <td>Design Review</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td colspan="4" style="border-left: 0;">◆ 22.01.14</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
        </tr>
        <tr>
            <td>Konzeption Software</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td colspan="7" style="background-color: #e8f0f8;">&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
        </tr>
        <tr>
            <td>Umsetzung Software</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td colspan="6" style="background-color: #e8f0f8;">&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
        </tr>
        <tr>
            <td>Feldversuch</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td colspan="8" style="background-color: #e8f0f8;">&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
        </tr>
        <tr>
            <td>Dokumentation</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td colspan="5" style="background-color: #e8f0f8;">&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
        </tr>
        <tr>
            <td>Messung RSSI</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td colspan="1" style="background-color: #e8f0f8;">&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
        </tr>
        <tr>
            <td>Abgabe Dokumentation</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td>&#160;</td>
            <td colspan="4" style="border-left: 0;">16.05.13 ◆</td>
        </tr>
    </tbody>
</table>
<figcaption>Projektablauf</figcaption>
</figure>

<p>
Laut dem Reglement für Semesterarbeiten sollte der Aufwand 120 Stunden betragen. 
Entsprechend wurde die Planung darauf ausgelegt. Die genauen technischen 
Anforderungen wurden allerdings erst während dem Projekt klar und führten zu 
einer iterativen Softwareentwicklung, wodurch mehr Zeit für die 
Konzeptions- und Umsetzungsphasen gebraucht wurde.
</p>

<figure id="figure-aufwand">
    <table class="inline">
        <colgroup>
            <col width="200" />
            <col width="50" />
            <col width="50" />
        </colgroup>
        <thead>
            <tr>
                <th>Beschreibung</th>
                <th>Soll</th>
                <th>Ist</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Analyse iBeacons</td>
                <td>10 h</td>
                <td>6 h</td>
            </tr>
            <tr>
                <td>Konzeption Software</td>
                <td>10 h</td>
                <td>14 h</td>
            </tr>
            <tr>
                <td>Umsetzung Web-Applikation</td>
                <td>25 h</td>
                <td>19 h</td>
            </tr>
            <tr>
                <td>Umsetzung Automatische Steuerung</td>
                <td>15 h</td>
                <td>35 h</td>
            </tr>
            <tr>
                <td>Umsetzung App</td>
                <td>25 h</td>
                <td>12 h</td>
            </tr>
            <tr>
                <td>Messung RSSI</td>
                <td>-</td>
                <td>23 h</td>
            </tr>
            <tr>
                <td>Dokumentation schreiben</td>
                <td>35 h</td>
                <td>39 h</td>
            </tr>
            <tr class="total">
                <td>Total</td>
                <td>120 h</td>
                <td>147 h</td>
            </tr>
        </tbody>
    </table>
    <figcaption>Soll / Ist Vergleich Aufwand</figcaption>
</figure>



</div>

<div class="chapter">
<h2>Analyse iBeacon</h2>

<h3>Beschreibung</h3>
<p>
Bei iBeacon handelt es sich um eine von Apple eingetragene Marke und beschreibt 
einen proprietären Technologie für die Lokalisierung eines iPhones mithilfe 
von Bluetooth Low Energy (BLE). Es setzt das Betriebssystem iOS 7 oder neuer, 
sowie ein iPhone mit Bluetooth 4.0 voraus. Das Wort Beacon wird zur Beschreibung 
eines Geräts mit eigener Sromversorgung verwendet, welches einen Standort markiert.
</p>

<figure>
<img src="images/ibeacon.png" width="70" height="70" class="inline">
<figcaption><a href="#ref-estimote-beacons" class="ref">iBeacon Logo</a></figcaption>
</figure>

<p>
Kommt ein iPhone in die Nähe eines Beacons, wird eine auf dem iPhone laufende App 
vom Betriebssystem benachrichtigt. Die App kann dann zusätzlich die Distanz zum 
Beacon abfragen und eigene Aktionen ausführen.
Vgl. <a href="#ref-understading-ibeacon" class="ref">iOS: Understanding iBeacon</a>.
</p>

<h3>Bluetooth Low Energy</h3>

<figure>
<img src="images/bluetooth-smart.jpg" class="inline">
<figcaption><a href="#ref-bluetooth-smart" class="ref">Logo Bluetooth Smart</a></figcaption>
</figure>

<p>
Bluetooth Low Energy (BLE) ist ein Funkprotokoll und Teil der 
Bluetooth&nbsp;4.0-Spezifikation. Vermarktet wird BLE auch als Bluetooth Smart.
Es wurde speziell für kleine Geräte mit limitierten Akkukapazitäten entwickelt und
kommt deshalb oft auf Smartphones zum Einsatz.
Vgl. <a href="#ref-bluetooth-smart" class="ref">Bluetooth Smart</a>.
</p>

<p>
Bluetooth Low Energy-Geräte nutzen das Generic Attribute Profile (GATT), um ihre 
Funktionalität zu beschreiben. GATT sieht Services und Characteristics vor, welche 
ein Gerät im Rahmen einen Profils anbieten kann. Dabei besteht eine 
hierarchische Beziehung zwischen Services und Characteristics. Services können 
zudem auf andere Services referenzieren (Include), um deren Characteristics zu erben. 
Profile dienen bei GATT zur formellen Gruppierung von mehreren Services.
</p>

<figure>
<img src="images/gatt-profile-hierarchy.png" width="350" class="inline">
<figcaption><a href="#ref-bluetooth-spec" class="ref">GATT Profilhierarchy, Seite 532</a></figcaption>
</figure>

<h3>Core Bluetooth</h3>
<p>
Apple bietet mit <a href="#ref-bluetooth-programming-guide" class="ref">Core Bluetooth</a> eine vereinfachte 
Schnittstelle zur Verwendung 
von BLE an, welche die BLE-Protokolle abstrahiert.</span>
</p>

<figure>
<img src="images/core-bluetooth-stack.png" width="160" class="inline">
<figcaption><a href="#ref-bluetooth-programming-guide" class="ref">Aufbau Core Bluetooth, Seite 5</a></figcaption>
</figure>

<p>Dabei wird bei der Programmierung zwischen zwei Rollen welche nach dem 
Client-Server-Prinzip aufgebaut sind unterschieden: Central und Peripheral.
Ein «Peripheral» (Server) stellt dabei Daten zur Verfügung und kann sich selbst über 
das regelmässige Aussenden von Informationen ankündigen (<em>Advertising</em>). 
Ein «Central» (Client) hingegen sucht nach Peripherals, und verarbeitet 
dessen Informationen in weitern Aktionen. Zum Beispiel kann ein digitaler 
Pulsmesser (Peripheral) mit BLE die aktuelle Herzfrequenz an eine iOS-App (Central) 
übermitteln und die iOS-App zeigt dann diese dem Benutzer an.</span>
</p>

<figure>
<img src="images/ble-roles.png" width="350" class="inline">
<figcaption><a href="#ref-bluetooth-programming-guide" class="ref">Rolen in Bluetooth Low Energy, Seite 9</a></figcaption>
</figure>

<h3>Analyse Format</h3>

<p>
Um der Funktionsweise von iBeacon auf die Spur zu kommen, wurde mit der 
Einarbeitung in die Grundtechnologie, auf der iBeacon basiert begonnen. Mit dem 
indirekten Ziel, einen Computer als iBeacon zu nutzen, wurde mit der Analyse 
auf einem Mac begonnen. Dazu wurde das bereits beschrieben Core Bluetooth Bibliothek verwendet, 
welche seit Version 10.9 von Mac OS X nicht nur auf iOS zur Verfügung steht. 
Damit sollte ein einfaches BLE-Profile veröffentlicht werden.
</p>

<p>
Anhand des 
Kapitels «Performing Common Peripheral Role Tasks» (Seite 16)
aus der von Apple zur Verfügung gestellten Dokumentation 
<a href="#ref-bluetooth-programming-guide" class="ref">«Core Bluetooth Programming Guide»</a> 
wurde ein minimales Programm mithilfe der Programmierumgebung Xcode erstellt, 
welches eigene BLE-Dienste anbietet.
</p>

<figure>
<pre><code>// create manager
CBPeripheralManager *manager = [[CBPeripheralManager alloc] initWithDelegate:self queue:nil options:nil];

// initialize UUIDs
CBUUID *characteristicUUID = [CBUUID UUIDWithString: @"2A38"];
CBUUID *serviceUUID = [CBUUID UUIDWithString: @"180D"];

// create value object
int heartRate = 42;
NSData *value = [NSData dataWithBytes: &heartRate length: sizeof(heartRate)];

// create service with characteristic
CBMutableCharacteristic *characteristic = [[CBMutableCharacteristic alloc] initWithType:characteristicUUID properties:CBCharacteristicPropertyRead value:value permissions:CBAttributePermissionsReadable];
CBMutableService *service = [[CBMutableService alloc] initWithType:serviceUUID primary:YES];
service.characteristics = @[characteristic];

// add service and advertise
[manager addService:service];
[manager startAdvertising:@{ CBAdvertisementDataServiceUUIDsKey : @[serviceUUID] }];
</code></pre>
<figcaption>Beispielanwendung von Core Bluetooth</figcaption>
</figure>

<p>
Konkret wurde mit der Beispiel-Anwendung mit einem Service für Herzfrequenzen mit dem 
UUID <em>180D</em> und mit einer Charakteristik für die Position des Sensors am 
Körper mit der UUID <em>2A38</em> entwickelt.
</p>

<p>
Die iPhone-App <a href="#ref-lightblue" class="ref">LightBlue</a> 
bietet die Möglichkeit, eine Verbindung zu beliebigen BLE-Geräte aufzubauen und 
die von den Geräten angebotenen Dienste abzurufen. Die App zeigt zudem die vom 
Gerät versendeten Advertising-Daten an. Die App wurde erfolgreich dazu verwendet, 
die von der Mac-Anwendung publizierten Services und Characteristics zu finden.
</p>

<figure>
<img src="images/screenshot-ble-test-ios.png" width="942">
<figcaption>
Screenshot LightBlue
</figcaption>
</figure>

<p>
Wie im Kapitel «<a href="https://developer.apple.com/library/ios/documentation/UserExperience/Conceptual/LocationAwarenessPG/RegionMonitoring/RegionMonitoring.html#//apple_ref/doc/uid/TP40009497-CH9-SW12">Turn Your iOS Device Into a Beacon</a>»
der <a href="#ref-location-programming-guide" class="ref">Dokumentation zu den iBeacons</a> beschrieben, wurde eine einfach iPhone-App 
erstellt, welche die Signale eines iBeacons vom iPhone aussendet. Dazu benötigt 
werden die beiden Bibliotheken <em>CoreBluetooth.framework</em> und <em>CoreLocation.framwork</em>.
</p>

<p>
Jedes Beacon braucht eine eindeutige UUID, anhand welcher es identifiert wird.
Um die Analyse des Protokols zu vereinfachen und die ID einfach auffindbar wurde
die UUID <code>FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF</code> definiert. Als Major 
wurde der Wert <code>00</code> (0) verwendet und als Minor <code>FF</code> (65535).
</p>

<figure>
<pre><code>NSUUID *proximityUUID = [[NSUUID alloc] initWithUUIDString:@"FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF"];

// Create the beacon region.
CLBeaconRegion *beaconRegion = [[CLBeaconRegion alloc] initWithProximityUUID:proximityUUID major:0 minor:65535 identifier:@"ch.zhaw.voglefab.debug"];

// Create a dictionary of advertisement data.
NSDictionary *beaconPeripheralData = [beaconRegion peripheralDataWithMeasuredPower:nil];

// Start advertising your beacon's data.
[self.peripheralManager startAdvertising:beaconPeripheralData];
</code></pre>
<figcaption>
Beispielanwendung von Core Bluetooth
</figcaption>
</figure>

<p>
Diese App wurde auf einem zweiten iPhone installiert und gestartet. Verbindet man 
sich jedoch nun mit LightBlue auf dem ersten iPhone mit dem zweiten iPhone, werden 
in LightBlue nur die Services <em>Battery Service</em> und <em>Current Time Service</em> 
angezeigt - iBeacon wird also kein Service im
GATT-Protokoll. Auch bei den Advertisement-Informationen ist das iBeacon in LightBlue 
nicht sichtbar. Trotz der neuen Erkentniss stellt sich dieser Lösungsansatz 
somit aber als Sackgasse heraus.
</p>

<figure>
<img src="images/screenshot-ble-test-ios-fail.png" width="200" class="inline">
<figcaption>
Screenshot LightBlue iBeacon
</figcaption>
</figure>

<p>
In einem weitern Schritt wurde auch nach Analyse-Tools auf dem Mac gesucht. 
Schliesslich wurde das Software-Packet <a href="#ref-hardware-io-tools" class="ref">Hardware IO Tools for Xcode</a> gefunden,
welches von Apple für Entwickler gratis zum Download bereit gestellt wird.
Dieses enthält unter anderem die Tools <em>PacketLogger</em> und 
<em>Bluetooth Explorer</em>, welche für die Analyse der iBeacons verwendet wurden.
</p>

<figure>
<img src="images/screenshot-ble-explorer-1.png" width="942">
<figcaption>
Screenshot Bluetooth Explorer
</figcaption>
</figure>

<p>
Das neue Ziel war nun, die Signale eines iBeacons auf dem Mac zu analysieren. Die 
Software PacketLogger bietet dazu eine Möglichkeit, die vom Computer 
empfangenen BLE-Packete zu analysieren. Scan man mit dem Bluetooth Explorer 
nach BLE-Geräten, werden im PacketLogger die empfangenen BLE Advertisements angezeigt.
</p>

<figure>
<img src="images/screenshot-packetlogger.png" width="1164">
<figcaption>
Screenshot PacketLogger
</figcaption>
</figure>

<p>
Dadurch wurde schlussendlich das Advertisement von der iPhone-App mit den Daten 
gefunden, welche das iBeacon-Signal aussendet. Verwendet wird hier die 
hexadezimale Schreibweise von Octet, zwei Hexzahlen entsprechen also einem Byte 
resp. 8 Bits.
</p>

<figure>
<pre class="inline"><code>02 01 1A 1A FF 4C 00 02 15 FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF 00 00 FF FF C5
</code></pre>
<figcaption>
Advertisement Daten iBeacon
</figcaption>
</figure>

<p>
Der Aufbau des Advertisements wird auf Kapitel <em>11 Advertising 
and Scan Response data format</em> im Volume 3 der 
<a href="#ref-bluetooth-spec" class="ref">Bluetooth-Spezifikation</a>
erklärt. Ein Advertisement besteht aus mehreren Elementen, welche eine variable Länge haben.
Am Anfang jedes Elements steht seine eigene Länge gefolgt vom Typ des Elements.
</p>

<figure>
<img src="images/structure-advertising-data.png">
<figcaption><a href="#ref-bluetooth-spec" class="ref">Struktur Advertising and Scan Response, Seite 375</a></figcaption>
</figure>

<p>
Angewendet auf das empfangene Advertisement ergibt sich folgendes Format für ein 
iBeacon. Gemäss Spezifikation enthalten die ersten zwei Octets des Manufacturer 
Sepcific Data den Company Identifier Code, welcher auf 
<a href="#ref-company-identifiers" class="ref">der Website der Bluetooth SIG</a> 
dokumentiert ist.
</p>


<figure>
<table class="table-extended inline" width="100%">
<tr><th>Byte</th><th>Beschreibung</th><th>Wert</th></tr>
<tr class="even"><td><code>02</code></td><td>Length</td><td>2</td></tr>
<tr class="even"><td><code>01</code></td><td>AD Type</td><td>Flags</td></tr>
<tr class="even"><td><code>1A</code></td><td>Flags</td><td>LE General Discoverable Mode<br/>Simultaneous LE and BR/EDR (Controller)<br/>Simultaneous LE and BR/EDR (Host)</td></tr>
<tr class="odd"><td><code>1A</code></td><td>Length</td><td>26</td></tr>
<tr class="odd"><td><code>FF</code></td><td>AD Type</td><td>Manufacturer Specific Data</td></tr>
<tr class="odd"><td><code>4C</code></td><td rowspan="2">Company Identifier Code</td><td rowspan="2">Apple, Inc.</td></tr>
<tr class="odd"><td><code>00</code></td></tr>
<tr class="odd"><td><code>02</code></td><td rowspan="2">Fixer Wert</td><td rowspan="2">iBeacon Identifier</td></tr>
<tr class="odd"><td><code>15</code></td></tr>
<tr class="odd"><td><code>FF</code></td><td rowspan="16">iBeacon UUID</td><td rowspan="16">FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF</td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>00</code></td><td rowspan="2">iBeacon Major</td><td rowspan="2">0</td></tr>
<tr class="odd"><td><code>00</code></td></tr>
<tr class="odd"><td><code>FF</code></td><td rowspan="2">iBeacon Minor</td><td rowspan="2">65535</td></tr>
<tr class="odd"><td><code>FF</code></td></tr>
<tr class="odd"><td><code>C5</code></td><td>Fixer Wert</td><td>Measured power</td></tr>
</table>
<figcaption>
Bluetooth Advertisement iBeacon
</figcaption>
</figure>

<p>
Das iBeacon-Format ist also innerhalb der Manufacturer Specific Data im 
BLE-Protokoll gekapselt. Dies konnte auch mit dem Bluetooth Explorer 
verfiziert werden, der ebenfalls die Manufacturer Data anzeigt. Um ein iBeacon zu 
erkennen oder zu simulieren, braucht man also legendlich ein Advertisement mit 
den entsprechenden Manufacturer Specific Data zu senden/empfangen.
</p>

<figure>
<img src="images/screenshot-ble-explorer-2.png" width="942">
<figcaption>
Screenshot Bluetooth Explorer nach Scan
</figcaption>
</figure>

<h3 class="break">Estimote Beacon</h3>

<p>
Für das Projekt wurden iBeacons von Estimote eingesetzt. Die «Estimote Beacons» 
wurden hauptsächlich für den Einsatz in Läden entwickelt und enthalten einen 
Bluetooth-Sender, der das iBeacon-Signal sendet. Da iBeacon eine neue 
Technologie ist, existierten zu Beginn des Projekt nur wenige Anbieter, welche 
Hardware für iBeacons anboten. Die Estimote Beacons wurde aufgrund ihrer 
Verfügbarkeit gewählt.
</p>

<p>
Estimote verfügt über eine eigene iPhone-App, mit welcher sich die Signalstärke
und der Sendeintervall der Beacons konfigurieren lässt. Die Beacons werden 
eigentlich wasserfest produziert. Leider waren die Batterien nach 5 Monaten 
aber bereits leer. Per Mail erhielt ich dann vom Estimote-Support eine Anleitung 
zum Austausch der Batterien. Für den Austausch muss das Beacon mit einem Messer 
aufgeschnitten werden - die Wasserfestigkeit geht dadurch natürlich verloren.
</p>

<figure>
<img src="images/DSC_6862.JPG" class="inline">
<figcaption>Foto Estimote Beacon</figcaption>
</figure>

<p>
Der Austausch der Batterie war dennoch interessant, da ich dadurch einen Blick
in den Inhalt der Beacons erhalten konnte. Die Beacons bestehen aus einer 
Leiterplatte mit Schaltkreisen. Die Batterie selbst ist eine Knopfbatterie vom 
Typ CR2450 und kann im Detailhandel gekauft werden.
</p>

<h3 class="break">Messung RSSI</h3>

<p>
Da sich die Signalstärke in den Estimote Beacons konfigurieren lässt, stellt sich 
die Frage, wie die optimale Konfiguration innerhalb einer Wohnung aussieht. 
Für folgende Wohnung wurden mehrere Messungen durchgeführt, um für jedes Beacon 
eine Signalstärke zu finden, die den Anforderungen entspricht.
</p>

<p>
Die empfangene Signalstärke kann in iOS über den RSSI-Wert (Received Signal Strength 
Indicator) ausgelesen werden. Je grösser der Wert ist, umso besser ist der 
Empfang, resp. umso näher befindet sich der Empfänger am Sender.
</p>

<p>
In einem ersten Schritt wurden die Bauzeichnungen der Wohnung eingescannt und 
mit der Gratis-Software <a href="#ref-sweet-home-3d" class="ref">Sweet Home 3D</a> 
digitalisiert. Die Wohnung besteht aus zwei Stockwerken, welche mit einer Treppe
verbunden sind. Auf dem ersten Stock befindet sich der Wohn- und Bürobereich.
</p>

<figure>
<img src="images/Bahnhfstr24-Floor1.png">
<figcaption>Visualisierung erster Stock</figcaption>
</figure>

<figure>
<img src="images/Bahnhfstr24-Floor2.png">
<figcaption>Visualisierung zweiter Stock</figcaption>
</figure>

<p>
Im zweiten Stock finden sich zwei Schlaf- sowie ein Badezimmer. Das Badezimmer 
befindet sich in der Visualisierung auf der rechten Seite.
</p>

<p>
In einem nächsten Schritt wurde die Wohnung in Raster unterteilt. Jedes Quadrat 
hat im Raster eine Seitenlänge von 120&nbsp;cm. Diese Länge wurde aufgrund der 
Gangbreite von 120&nbsp;cm gewählt, da der Gang normalerweise in der Mitte 
durchschritten wird und eine mehrfache Messung dort nur wenig Sinn machen würde.
Das Raster wurde mit Malerklebband auf die Wohung übertragen, um die Durchführung 
der Messung effizient zu gestalten.
</p>

<p>
Für die Messung wurde eine iPhone-App entwickelt, auf welcher sich die 
Signalstärke sowie die Koordinaten des iPhones innerhalb der Wohnung 
konfigurieren lassen. Die App empfängt alle iBeacon-Signale und deren RSSI-Wert.
Aktiviert man dann die Messung, wartet die App 10&nbsp;Sekunden 
und überträgt dann die empfangenen RSSI-Werte an einen Web-Server zur Auswertung.
</p>

<figure>
<img src="images/Screenshot-App.png" class="inline" width="200">
<figcaption>Screenshot iPhone-App</figcaption>
</figure>

<p>
Gemessen wurde auf einer Höhe von 90&nbsp;cm. Auf dieser Höhe befindet sich das iPhone 
normalerweise auch, wenn es in der Hosentasche getragen wird. Für die Messung 
wurde das iPhone auf einem Stativ montiert, damit die Messung ohne Störungsquellen 
durchgeführt werden kann.
</p>

<figure>
<img src="images/Messung.jpg">
<figcaption>Fotos Messung</figcaption>
</figure>

<p>
Für die Messung wurde das Advertisting Interval alle Estimote Beacons auf 500&nbsp;ms
eingestellt. Das iPhone hatte zu Beginn einer Messung jeweils 100% Akku.
Der Batteriestand fiel während der Messung nie unter 60%. Auch die Estimote 
Beacons hatten frische Batterien.
</p>

<p>
Während eines ersten Probelauf mit 10 Sekunden warten und 30&nbsp;Sekunden messen 
zeigte sich, dass die 10 Sekunden Wartezeit genügen, um sich ausserhalb des 
Messbereichs zu begeben. Die 30 Sekunden Messzeit erwiesen sich allerdings als 
zu lang, anhand der aufgezeichneten Daten wurde deshalb die Messzeit auf 20&nbsp;Sekunden 
reduziert.
</p>

<p>
Ablauf einer Messung:
</p>

<ol>
<li>Zu messender Signalstärke definieren</li>
<li>Alle iBeacons auf die definierte Signalstärke einstellen</li>
<li>App auf iPhone starten</li>
<li>Signalstärke in App eintragen</li>
<li>iPhone auf Stativ montieren</li>
<li>Stativ in der Mitte eines Felds platzieren</li>
<li>Koordinaten von Plan ablesen und in App eintragen</li>
<li>Schalter "Messung" in App auf aktiv stellen</li>
<li>Sich innerhalb von 10 Sekunden aus dem Messfeld entfernen</li>
<li>30 Sekunden warten</li>
<li>Zurück zu Schritt 6 bis alle Felder/Koordinaten gemessen wurden</li>
</ol>

<h4 class="break">Messprotokolle</h4>

<p>
Die folgenden Messprotokolle geben Auskunft über die Durchführung der Messungen.
</p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Signalstärke</th>
    <td>-12 dBm</td>
</tr>
<tr>
    <th>Datum</th>
    <td>01.05.2014</td>
</tr>
<tr>
    <th>Zeit Beginn</th>
    <td>10:46</td>
</tr>
<tr>
    <th>Zeit Ende</th>
    <td>12:40</td>
</tr>
<tr>
    <th>Messende Person</th>
    <td>Fabian Vogler</td>
</tr>
<tr>
    <th>Notizen</th>
    <td>Beim Start der Messung des 2. Stockwerks wurde festgestellt, dass ein 
        Beacon nicht gemessen wurde. Offenbar hat das Beacon kurzzeitig keine 
        Daten gesendet. Der Wert wurde gelöscht und die Messung für dieses 
        Feld erfolgreich wiederholt.</td>
</tr>
</tbody>
</table>
<figcaption>Protokoll Messung 1</figcaption>
</figure>

<p></p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Signalstärke</th>
    <td>-4 dBm</td>
</tr>
<tr>
    <th>Datum</th>
    <td>01.05.2014</td>
</tr>
<tr>
    <th>Zeit Beginn</th>
    <td>16:39</td>
</tr>
<tr>
    <th>Zeit Ende</th>
    <td>17:58</td>
</tr>
<tr>
    <th>Messende Person</th>
    <td>Fabian Vogler</td>
</tr>
<tr>
    <th>Notizen</th>
    <td>Es sind keine Probleme aufgetreten.</td>
</tr>
</tbody>
</table>
<figcaption>Protokoll Messung 2</figcaption>
</figure>

<p></p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Signalstärke</th>
    <td>-20 dBm</td>
</tr>
<tr>
    <th>Datum</th>
    <td>06.05.2014</td>
</tr>
<tr>
    <th>Zeit Beginn</th>
    <td>09:12</td>
</tr>
<tr>
    <th>Zeit Ende</th>
    <td>10:31</td>
</tr>
<tr>
    <th>Messende Person</th>
    <td>Fabian Vogler</td>
</tr>
<tr>
    <th>Notizen</th>
    <td>Neu wurde ein iPad zur laufenden Überwachung der Resultate eingesetzt. Es sind jedoch keine Probleme festgestellt worden.</td>
</tr>
</tbody>
</table>
<figcaption>Protokoll Messung 3</figcaption>
</figure>

<p>
Bei den nachfolgenden Auswertungen wurde die Position des gemessenen Beacons 
im Wohnungsplan jeweils durch eine schwarze Raute gekennzeichnet.
</p>

<h4>Auswertung Beacon 1</h4>

<p>
Dieses Beacon befindet sich im Wohnzimmer der Wohnung. Die Signalstärke
-12 dBm wird aufgrund der guten Abdeckung des ganzen ersten Stocks für dieses
Beacon festgelegt.
</p>

<figure>
<img src="images/Mint-4.png" class="inline">
<figcaption>Visualisierung RSSI Beacon 1, -4 dBm</figcaption>
</figure>

<p></p>

<figure>
<img src="images/Mint-12.png" class="inline">
<figcaption>Visualisierung RSSI Beacon 1, -12 dBm</figcaption>
</figure>

<p></p>

<figure>
<img src="images/Mint-20.png" class="inline">
<figcaption>Visualisierung RSSI Beacon 1, -20 dBm</figcaption>
</figure>

<h4>Auswertung Beacon 2</h4>

<p>
Dieses Beacon befindet sich in einem Schlafzimmer. Um zu verhindern, dass das 
Licht im Schlafzimmer unnötig brennt wird die Signalstärke dieses Beacons auf
-4 dBm festgelegt.
</p>

<figure>
<img src="images/Blueberry-4.png" class="inline">
<figcaption>Visualisierung RSSI Beacon 2, -4 dBm</figcaption>
</figure>

<p></p>

<figure>
<img src="images/Blueberry-12.png" class="inline">
<figcaption>Visualisierung RSSI Beacon 2, -12 dBm</figcaption>
</figure>

<p></p>

<figure>
<img src="images/Blueberry-20.png" class="inline">
<figcaption>Visualisierung RSSI Beacon 2, -20 dBm</figcaption>
</figure>

<h4>Auswertung Beacon 3</h4>

<p>
Dieses Beacon befindet sich direkt im Eingansbereich der Wohnung und soll die  
Beleuchtung im Gang steuern. Es wird deshalb die  Signalstärke -4 dBm für 
dieses Beacon festgelegt.
</p>

<figure>
<img src="images/Ice-4.png" class="inline">
<figcaption>Visualisierung RSSI Beacon 3, -4 dBm</figcaption>
</figure>

<p></p>

<figure>
<img src="images/Ice-12.png" class="inline">
<figcaption>Visualisierung RSSI Beacon 3, -12 dBm</figcaption>
</figure>

<p></p>

<figure>
<img src="images/Ice-20.png" class="inline">
<figcaption>Visualisierung RSSI Beacon 3, -20 dBm</figcaption>
</figure>

</div>

<div class="chapter">
<h2>Anforderungsanalyse</h2>

<h3>Einleitung</h3>

<p>
Das manuelle Bedienen von Lichtern in einer Wohnung ist oft mühsam und 
ineffizient. Die Lichtschalter sind an ungünstigen Orten angebracht oder das 
Licht wird beim Verlassen des Hauses auszuschalten vergessen.
</p>

<p>
Es soll deshalb eine Softwarelösung entwickelt werden, welche die Lichter in 
einem Haus automatisch steuert. Betritt der Bewohner einen Raum, sollen die 
Lichter im Raum angehen - beim Verlassen des Raums sollen die Lichter wieder 
automatisch ausgehen. Dies spart Strom und erleichtert den Alltag.
</p>

<h3>Stakeholder</h3>

<p>
Die folgenden Stakeholder haben einen direkten oder indirekten Einfluss auf die 
Anforderungen. Diese Stakeholder finden sich ebenfalls im nachfolgenden 
Kontextdiagramm.
</p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Stakeholder</th>
    <th>Beschreibung</th>
</tr>
<tr>
    <td>Bewohner</td>
    <td>Der Bewohner der Wohnung ist die massgebende Zielperson. Die Anwendung soll sein Leben vereinfachen, die funktionalen Anforderungen sind deshalb auf Ihn ausgelegt.</td>
</tr>
<tr>
    <td>Besucher</td>
    <td>Besucher der Wohnung wissen im Normalfall nichts über die im Hintergrund laufende Anwendung und müssen vor Überraschungen geschützt werden.</td>
</tr>
<tr>
    <td>Beacon-Hersteller</td>
    <td>Der Beacon-Hersteller entwickelt und liefert die nötige Hardware in Form der Beacons für die Anwendung. Er hat einen Einfluss auf die technischen Anforderungen.</td>
</tr>
<tr>
    <td>Lampen-Hersteller</td>
    <td>Der Lampen-Hersteller entwickelt und produziert die steuerbaren Lampen. Er definiert die technischen Möglichkeiten der Beleuchtung.</td>
</tr>
<tr>
    <td>Apple</td>
    <td>Apple als Entwickler des iBeacon-Formats definiert die technischen Vorgaben und nimmt evtl. in Zukunft Änderungen am Format vor.</td>
</tr>
</tbody>
</table>
<figcaption>Stakeholder</figcaption>
</figure>

<h3>Systemkontext</h3>

<p>
Die Kontextabgrenzung dient zur Definition der Elemente, welche einen Einfluss 
auf das System haben. Das System selbst, die automatische Steuerung, wird durch 
den Bewohner und die Beacons beeinflusst und steuert das Licht. Besucher kommen 
innerhalb des Systemkontexts ebenfalls vor, haben aber keinen direkten Einfluss 
auf das System.
</p>

<figure>
<img src="images/Kontextdiagramm.png">
<figcaption>
Kontextdiagramm
</figcaption>
</figure>


<h3 class="break">Funktionale Anforderungen</h3>

<p>
Die funktionalen Anforderungen wurden mit der Beobachtungstechnik und anhand 
der eigenen Erfahrungen definiert und als Anwendungsfälle festgehalten.
</p>

<p>
Das folgender Anwendungsfalldiagramm gibt einen Überblick über die erfassten 
Anwendungsfälle. Es gibt zwei Aktoren, den Benutzer sowie die automatische 
Steuerung.
</p>

<figure>
<img src="images/Anwendungsfalldiagramm.png" class="inline">
<figcaption>
Anwendungsfalldiagramm
</figcaption>
</figure>

<p class="break">
Die Anwendungsfälle wurden mit den im folgendem Schema definierten Attributen 
erfasst.
</p>


<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="20%" />
    <col width="80%" />
</colgroup>
<tbody>
<tr>
    <th>Attribut</th>
    <th>Beschreibung</th>
</tr>
<tr>
    <td>Identifier</td>
    <td>Eindeutige Nummer des Anwendungsfalls.</td>
<tr>
    <td>Name</td>
    <td>Kurzname des Anwendungsfalls.</td>
</tr>
<tr>
    <td>Priorität</td>
    <td>Dringlichkeit des Anwendungsfalls mit dem Wertebereich tief, mittel und hoch.</td>
</tr>
<tr>
    <td>Auslöser</td>
    <td>Beschreibung des Ereignisses, welches diesen Anwendungsfall relevant macht.</td>
</tr>
<tr>
    <td>Beschreibung</td>
    <td>Kurze Zusammenfassung des Anwendungsfalls.</td>
</tr>
<tr>
    <td>Vorbedingungen</td>
    <td>Voraussetzungen welche für die Ausführung dieses Anwendungsfalls erfüllt sein müssen.</td>
</tr>
<tr>
    <td>Standardablauf</td>
    <td>Schritte zur erfolgreichen Ausführung des Anwendungsfalls.</td>
</tr>
<tr>
    <td>Ergebnis</td>
    <td>Das Resultat nach der erfolgreichen Ausführung des Standardablaufs.</td>
</tr>
<tr>
    <td>Ausnahmen</td>
    <td>Eventuell auftrettende Ausnahmesituationen sowie deren Konsequenzen.</td>
</tr>
</tbody>
</table>
<figcaption>Attribute Anwendungsfall</figcaption>
</figure>


<h4>Anwendungsfälle</h4>


<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Identifier</th>
    <td>UC01</td>
</tr>
<tr>
    <th>Name</th>
    <td>Neues Beacon erfassen</td>
</tr>
<tr>
    <th>Priorität</th>
    <td>mittel</td>
</tr>
<tr>
    <th>Auslöser</th>
    <td>Der Benutzer konfiguriert das System zum ersten Mal oder ist in Besitz eines neuen Beacons gekommen.</td>
</tr>
<tr>
    <th>Beschreibung</th>
    <td>Der Benutzer erfasst ein neues Beacon mit einem eigenen Namen.</td>
</tr>
<tr>
    <th>Vorbedingungen</th>
    <td>
        <ul>
            <li>Der Benutzer muss die UUID sowie den Major- und den Minor-Wert des Beacons kennen.</li>
            <li>Der Benutzer ist in der Anwendung eingeloggt und befindet sich auf der Ansicht zur Konfiguration der Beacons.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Standardablauf</th>
    <td>
        <ul>
            <li>Der Benutzer klickt auf «Beacon hinzufügen».</li>
            <li>Es erscheint ein Formular zur Erfassung des Beacons.</li>
            <li>Der Benutzer füllt den Namen, die UUID, den Major- und den Minor-Wert ein.</li>
            <li>Der Benutzer klickt auf «Beacon speichern».</li>
            <li>Das Beacon wird gespeichert.</li>
            <li>Es wird wieder die Ansicht zur Konfiguration mit einer Erfolgsmeldung über die erfolgreiche Speicherung des Beacons angezeigt.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Ergebnis</th>
    <td>Das neue Beacon erscheint auf der Konfigurationsansicht und kann einem Licht zugewiesen werden.</td>
</tr>
<tr>
    <th>Ausnahmen</th>
    <td>
        <ul>
            <li>Es ist bereits ein Beacon mit der selben UUID, Major- und Minor-Werten erfasst; in diesem Fall soll das Beacon nicht gespeichert und eine Fehlermeldung angezeigt werden.</li>
        </ul>
    </td>
</tr>
</tbody>
</table>
<figcaption>UC01 Neues Beacon erfassen</figcaption>
</figure>

<p>
</p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Identifier</th>
    <td>UC02</td>
</tr>
<tr>
    <th>Name</th>
    <td>Beacon zu Lichtern zuweisen</td>
</tr>
<tr>
    <th>Priorität</th>
    <td>hoch</td>
</tr>
<tr>
    <th>Auslöser</th>
    <td>Der Benutzer konfiguriert das System zum ersten Mal, ist in Besitz eines neuen Beacons oder einer neuen Lampe gekommen.</td>
</tr>
<tr>
    <th>Beschreibung</th>
    <td>Der Benutzer weisst ein Beacon zu einem oder mehreren Lichtern zu.</td>
</tr>
<tr>
    <th>Vorbedingungen</th>
    <td>
        <ul>
            <li>Es wurde ein Beacon erfasst.</li>
            <li>Es ist mindestens eine Lampe vorhanden.</li>
            <li>Der Benutzer ist in der Anwendung eingeloggt und befindet sich auf der Ansicht zur Konfiguration der Beacons.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Standardablauf</th>
    <td>
        <ul>
            <li>Der Benutzer wählt die gewünschten Lichter aus.</li>
            <li>Der Benutzer klickt auf «Zuweisung speichern».</li>
            <li>Die Zuweisung der Lichter zum Beacon wird gespeichert.</li>
            <li>Es wird wieder die Ansicht zur Konfiguration mit einer Erfolgsmeldung über die erfolgreiche Speicherung der Zuweisung angezeigt.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Ergebnis</th>
    <td>Die automatische Steuerung schaltet die ausgewälten Lichter an, sobald der Benutzer in der Nähe des Beacons ist.</td>
</tr>
</tbody>
</table>
<figcaption>UC02 Beacons zu Lichtern zuweisen</figcaption>
</figure>

<p>
</p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Identifier</th>
    <td>UC03</td>
</tr>
<tr>
    <th>Name</th>
    <td>Namen eines Beacons ändern</td>
</tr>
<tr>
    <th>Priorität</th>
    <td>tief</td>
</tr>
<tr>
    <th>Auslöser</th>
    <td>Ein Beacon wurde neu positioniert oder es wurde ein Schreibfehler festgestellt.</td>
</tr>
<tr>
    <th>Beschreibung</th>
    <td>Der Benutzer ändert den Namen eines bestehenden Beacons.</td>
</tr>
<tr>
    <th>Vorbedingungen</th>
    <td>
        <ul>
            <li>Das Beacon wurde zuvor erfasst.</li>
            <li>Der Benutzer ist in der Anwendung eingeloggt und befindet sich auf der Ansicht zur Konfiguration der Beacons.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Standardablauf</th>
    <td>
        <ul>
            <li>Der Benutzer klickt bei dem gewünschten Beacon auf «Bearbeiten».</li>
            <li>Es erscheint ein Formular mit dem Namen des Beacons.</li>
            <li>Der Benutzer ändert den Namen des Beacons.</li>
            <li>Der Benutzer klickt auf «Beacon speichern».</li>
            <li>Das Beacon wird gespeichert.</li>
            <li>Es wird wieder die Ansicht zur Konfiguration mit einer Erfolgsmeldung über die erfolgreiche Speicherung des Beacons angezeigt.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Ergebnis</th>
    <td>Das Beacon erscheint mit dem geänderten Namen auf der Konfigurationsansicht.</td>
</tr>
</tbody>
</table>
<figcaption>UC03 Namen eines Beacons ändern</figcaption>
</figure>

<p>
</p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Identifier</th>
    <td>UC04</td>
</tr>
<tr>
    <th>Name</th>
    <td>Beacon ausblenden</td>
</tr>
<tr>
    <th>Priorität</th>
    <td>tief</td>
</tr>
<tr>
    <th>Auslöser</th>
    <td>Ein Beacon wurde entfernt oder ist nicht mehr relevant.</td>
</tr>
<tr>
    <th>Beschreibung</th>
    <td>Der Benutzer markiert ein Beacon als inaktiv.</td>
</tr>
<tr>
    <th>Vorbedingungen</th>
    <td>
        <ul>
            <li>Das Beacon wurde zuvor erfasst.</li>
            <li>Der Benutzer ist in der Anwendung eingeloggt und befindet sich auf der Ansicht zur Konfiguration der Beacons.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Standardablauf</th>
    <td>
        <ul>
            <li>Der Benutzer klickt bei dem gewünschten Beacon auf «Bearbeiten».</li>
            <li>Es erscheint ein Formular mit dem Status des Beacons.</li>
            <li>Der Benutzer ändert den Status des Beacons auf «Inaktiv».</li>
            <li>Der Benutzer klickt auf «Beacon speichern».</li>
            <li>Das Beacon wird gespeichert.</li>
            <li>Es wird wieder die Ansicht zur Konfiguration mit einer Erfolgsmeldung über die erfolgreiche Speicherung des Beacons angezeigt.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Ergebnis</th>
    <td>Das Beacon wird in der Konfigurationsansicht in einer separaten Liste aufgeführt und kann nicht mehr Lichtern zugewiesen werden.</td>
</tr>
</tbody>
</table>
<figcaption>UC04 Beacon ausblenden</figcaption>
</figure>

<p>
</p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Identifier</th>
    <td>UC05</td>
</tr>
<tr>
    <th>Name</th>
    <td>Beacon einblenden</td>
</tr>
<tr>
    <th>Priorität</th>
    <td>tief</td>
</tr>
<tr>
    <th>Auslöser</th>
    <td>Ein Beacon wurde wieder relevant nachdem es deaktiviert wurde.</td>
</tr>
<tr>
    <th>Beschreibung</th>
    <td>Der Benutzer markiert ein Beacon als aktiv.</td>
</tr>
<tr>
    <th>Vorbedingungen</th>
    <td>
        <ul>
            <li>Das Beacon wurde zuvor erfasst.</li>
            <li>Das Beacon ist inaktiv.</li>
            <li>Der Benutzer ist in der Anwendung eingeloggt und befindet sich auf der Ansicht zur Konfiguration der Beacons.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Standardablauf</th>
    <td>
        <ul>
            <li>Der Benutzer klickt bei dem gewünschten Beacon auf «Bearbeiten».</li>
            <li>Es erscheint ein Formular mit dem Status des Beacons.</li>
            <li>Der Benutzer ändert den Status des Beacons auf «Aktiv».</li>
            <li>Der Benutzer klickt auf «Beacon speichern».</li>
            <li>Das Beacon wird gespeichert.</li>
            <li>Es wird wieder die Ansicht zur Konfiguration mit einer Erfolgsmeldung über die erfolgreiche Speicherung des Beacons angezeigt.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Ergebnis</th>
    <td>Das Beacon wird in der Konfigurationsansicht wieder normale dargestellt und kann Lichtern zugewiesen werden.</td>
</tr>
</tbody>
</table>
<figcaption>UC05 Beacon einblenden</figcaption>
</figure>

<p>
</p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Identifier</th>
    <td>UC06</td>
</tr>
<tr>
    <th>Name</th>
    <td>Automatisch Licht einschalten</td>
</tr>
<tr>
    <th>Priorität</th>
    <td>hoch</td>
</tr>
<tr>
    <th>Auslöser</th>
    <td>Der Benutzer kommt in die Nähe eines Beacons, welches dem Licht zugewiesen ist.</td>
</tr>
<tr>
    <th>Beschreibung</th>
    <td>Das zugewiese Licht wird eingeschaltet.</td>
</tr>
<tr>
    <th>Vorbedingungen</th>
    <td>
        <ul>
            <li>Das Beacon wurde zuvor erfasst und ist aktiv.</li>
            <li>Das Beacon ist einem Licht zugewiesen.</li>
            <li>Das Licht hat Strom (wurde also nicht durch einen Lichtschalter ausgeschaltet).</li>
            <li>Der Benutzer hat die App installiert und diese erfolgreich autorisiert.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Standardablauf</th>
    <td>
        <ul>
            <li>Der Benutzer kommt in die Nähe des Beacons.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Ergebnis</th>
    <td>Das Licht geht an und leuchtet.</td>
</tr>
</tbody>
</table>
<figcaption>UC06 Automatisch Licht einschalten</figcaption>
</figure>

<p>
</p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Identifier</th>
    <td>UC07</td>
</tr>
<tr>
    <th>Name</th>
    <td>Automatisch Licht ausschalten</td>
</tr>
<tr>
    <th>Priorität</th>
    <td>hoch</td>
</tr>
<tr>
    <th>Auslöser</th>
    <td>Der Benutzer entfernt sich vom Beacon, welches dem Licht zugewiesen ist.</td>
</tr>
<tr>
    <th>Beschreibung</th>
    <td>
        Das zugewiese Licht wird nach 3 Minuten ausgeschaltet. Diese 3 Minuten Wartezeit
        dienen auch zur Verhinderung von flackernden Lichtern, falls der Benutzer nur
        kurzzeitig (z.B. aufgrund einer Signalschwankung) ausserhalb des Bereichs
        gemeldet wird.
    </td>
</tr>
<tr>
    <th>Vorbedingungen</th>
    <td>
        <ul>
            <li>Das Beacon wurde zuvor erfasst und ist aktiv.</li>
            <li>Das Beacon ist einem Licht zugewiesen.</li>
            <li>Das Licht leuchtet.</li>
            <li>Der Benutzer hat die App installiert und diese erfolgreich autorisiert.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Standardablauf</th>
    <td>
        <ul>
            <li>Der Benutzer entfernt sich vom Beacon.</li>
            <li>Der Benutzer bleibt 3 Minuten vom Beacon weg.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Ergebnis</th>
    <td>Das Licht geht aus und leuchtet nicht mehr.</td>
</tr>
<tr>
    <th>Ausnahmen</th>
    <td>
        <ul>
            <li>Der Benutzer nähret sich innerhalb von 3 Minuten wieder dem Beacon; das Licht wird in diesem Fall nicht ausgeschaltet.</li>
        </ul>
    </td>
</tr>
</tbody>
</table>
<figcaption>UC07 Automatisch Licht ausschalten</figcaption>
</figure>

<p>
</p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Identifier</th>
    <td>UC08</td>
</tr>
<tr>
    <th>Name</th>
    <td>Steuerung pausieren</td>
</tr>
<tr>
    <th>Priorität</th>
    <td>mittel</td>
</tr>
<tr>
    <th>Auslöser</th>
    <td>Eine Person zusätzliche Person (z.B. ein Besucher) betrit die Wohnung und möchte nicht im Dunkeln stehen, wenn der Benutzer mit der App einen anderen Raum betritt.</td>
</tr>
<tr>
    <th>Beschreibung</th>
    <td>Der Benutzer pausiert die automatische Steuerung für eine unbegrenzte Zeit.</td>
</tr>
<tr>
    <th>Vorbedingungen</th>
    <td>
        <ul>
            <li>Der Benutzer ist in der Anwendung eingeloggt und befindet sich auf der Startseite.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Standardablauf</th>
    <td>
        <ul>
            <li>Der Benutzer klickt auf «Steuerung pausieren».</li>
            <li>Der Status der Steuerung wird als pausiert angezeigt.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Ergebnis</th>
    <td>Die automatische Steuerung der Lichter wird pausiert, es werden keine Lichter mehr automatisch an- und ausgeschaltet.</td>
</tr>
</tbody>
</table>
<figcaption>UC08 Steuerung pausieren</figcaption>
</figure>

<p>
</p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Identifier</th>
    <td>UC09</td>
</tr>
<tr>
    <th>Name</th>
    <td>Steuerung wieder aktivieren</td>
</tr>
<tr>
    <th>Priorität</th>
    <td>mittel</td>
</tr>
<tr>
    <th>Auslöser</th>
    <td>Die zusätzliche Person (z.B. ein Besucher) verlässt die Wohnung wieder.</td>
</tr>
<tr>
    <th>Beschreibung</th>
    <td>Der Benutzer aktiviert die automatische Steuerung wieder für eine unbegrenzte Zeit.</td>
</tr>
<tr>
    <th>Vorbedingungen</th>
    <td>
        <ul>
            <li>Der Benutzer ist in der Anwendung eingeloggt und befindet sich auf der Startseite.</li>
            <li>Die Steuerung wurde pausiert.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Standardablauf</th>
    <td>
        <ul>
            <li>Der Benutzer klickt auf «Steuerung aktivieren».</li>
            <li>Der Status der Steuerung wird als aktiv angezeigt.</li>
        </ul>
    </td>
</tr>
<tr>
    <th>Ergebnis</th>
    <td>Die automatische Steuerung der Lichter ist wieder aktiv, Lichter werden wieder automatisch an- und ausgeschaltet.</td>
</tr>
</tbody>
</table>
<figcaption>UC09 Steuerung wieder aktivieren</figcaption>
</figure>

<h3 class="break">Nichtfunktionale Anforderungen</h3>

<p>
Neben den funktionalen Anforderungen gibt es auch gewisse nichtfunktionale 
Anforderungen, die teilweise implizit vom Benutzer erwartet werden. Diese 
Qualitätsanforderungen müssen sowohl messbar wie auch  
</p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Identifier</th>
    <td>Q01</td>
</tr>
<tr>
    <th>Name</th>
    <td>Erlernbarkeit</td>
</tr>
<tr>
    <th>Beschreibung</th>
    <td>Die Bedienung der Anwendung soll durch einen Benutzer auch ohne Anleitung innerhalb von einem Tag verstanden werden können. Vom Benutzer begangene Fehler sollen jederzeit wieder rückgängig gemacht werden können.</td>
</tr>
</tbody>
</table>
<figcaption>Q01 Erlernbarkeit</figcaption>
</figure>

<p></p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Identifier</th>
    <td>Q02</td>
</tr>
<tr>
    <th>Name</th>
    <td>Änderbarkeit</td>
</tr>
<tr>
    <th>Beschreibung</th>
    <td>Um auch zukünftige Anforderungen umsetzen zu können, soll die Anwendung erweiterbar geschrieben werden. Es muss möglich sein, weiter Funktionen einzubauen ohne bestehende zu beeiträchtigen.</td>
</tr>
</tbody>
</table>
<figcaption>Q02 Änderbarkeit</figcaption>
</figure>

<p></p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Identifier</th>
    <td>Q03</td>
</tr>
<tr>
    <th>Name</th>
    <td>Portabilität</td>
</tr>
<tr>
    <th>Beschreibung</th>
    <td>Die Anwendung soll auf einem einfachen Web-Server betrieben werden können, welcher PHP und MySQL unterstützt.</td>
</tr>
</tbody>
</table>
<figcaption>Q03 Portabilität</figcaption>
</figure>

<p></p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Identifier</th>
    <td>Q04</td>
</tr>
<tr>
    <th>Name</th>
    <td>Sicherheit</td>
</tr>
<tr>
    <th>Beschreibung</th>
    <td>Die Anwendung soll durch ein Login geschützt sein. Der Benutzer muss sich mit seinem Benutzernamen und Passwort authentifizieren, um die Anwendung zu benutzen.</td>
</tr>
</tbody>
</table>
<figcaption>Q04 Sicherheit</figcaption>
</figure>

<p></p>

<figure>
<table class="inline" width="100%">
<colgroup>
    <col width="30%" />
    <col width="70%" />
</colgroup>
<tbody>
<tr>
    <th>Identifier</th>
    <td>Q05</td>
</tr>
<tr>
    <th>Name</th>
    <td>Performance</td>
</tr>
<tr>
    <th>Beschreibung</th>
    <td>Alle Ansichten der Anwendungen sollen innerhalb von 0.9 Sekunden angezeigt werden.</td>
</tr>
</tbody>
</table>
<figcaption>Q05 Performance</figcaption>
</figure>

<h3 class="break">Benutzerschnittstellen</h3>

<p>
Die folgenden Mockups dienen dazu, die Anforderungen visuell darzustellen. Es 
werden die drei wichtigsten Ansichten gezeigt.
</p>

<p>
Das Dashboard wird beim Starten der Anwendung, jedesmal wenn sich der Benutzer 
eingeloggt hat, angezeigt. Im Dashboard erhält der Benutzer eine Übersicht über 
die letzten Events der Engine. Er kann zudem die Engine pausieren und wieder 
starten.
</p>

<figure>
<img src="mockups/homebase.png" class="inline">
<figcaption>Mockup Dashboard</figcaption>
</figure>

<p class="break">
Der Report zeigt dem Benutzer Informationen über die Brenndauer der Lichter 
während der letzten Tage an.
</p>

<figure>
<img src="mockups/homebase-report.png" class="inline">
<figcaption>Mockup Report</figcaption>
</figure>

<p>
Im Setup kann der Benutzer die Beacons den Lichtern zuweisen.
</p>

<figure>
<img src="mockups/homebase-setup.png" class="inline">
<figcaption>Mockup Setup</figcaption>
</figure>


</div>

<div class="chapter">
<h2>Konzept und Design</h2>

<h3>Randbedingungen</h3>

<p>
Um eine möglichst hohe Portabilität zu gewährleisten und die Anwendung auf einem 
einfachen Webserver betreiben zu können, soll die Anwendung mit PHP und MySQL 
entwickelt werden.
</p>

<p>
Das iBeacon ein von Apple entwickeltes Datenformat ist, bietet die iOS-Plattform 
Bibliotheken zur einfachen Umsetzung. Es soll deshalb eine iPhone-App mit 
Objective-C entwickelt werden.
</p>

<h3>Lösungsstrategie</h3>

<p>
Das umgesetzte Software besteht aus zwei Komponenten, einer iPhone-App 
sowie einer Web-Applikation. Die Aufgabe der iPhone-App ist legendlich, die 
Position des Benutzers zu ermitteln und diese an die Web-Applikation zu übertragen.
Die Web-Applikation hat eine Anbindung an eine Datenbank 
und speichert dort alle Positionsangaben, steuert die Beleuchtung und stellt die 
gesammelten Informationen für den Benutzer dar.
</p>

<p>
Ein zentrales Element der Web-Applikation ist die <em>Engine</em>, welche die 
aktuellen Positionsdaten analysiert und entscheidet, welche Lichter an- und 
welche ausgeschaltet werden sollen.
</p>

<h3>Bausteinsicht</h3>

<figure>
<img src="images/Komponentendiagramm.png">
<figcaption>
Komponentendiagramm
</figcaption>
</figure>

<h4>iPhone-App</h4>

<p>
Die iPhone-App besteht nur aus einer Klasse, welche durch das Betriebssystem 
über das Delegate-Pattern aufgerufen wird, sobald der Benutzer den Bereich eines
Beacons betritt oder verlässt. Dieses Klasse sendet dann diese Informationen 
über eine HTTP-Anfrage an den Server.
</p>

<h4>Web-Applikation</h4>

<p>
Die Web-Applikation wurde nach dem klassichen MVC-Pattern in PHP umgesetzt: Anfragen 
werden im Controller entgegengenommen, die Daten an das Model weitergeleitet und 
schlussendlich in der View dargestellt.
</p>

<p>
Da PHP nur wenig Funktionalität zur komplexeren Verarbeitung von HTTP-Anfragen 
bietet, wurde das Micro-Framework <a href="#ref-silex" class="ref">Silex</a> 
verwendet. Dieses stellt Funktionen für das Routing zur Verfügung und erlaubt 
die einfache Benutzung der Templating-Engine <a href="#ref-twig" class="ref">Twig</a>.
</p>

<p>
Das nachfolgende Klassendiagramm beschreibt die Klassen im Packet <code>Homebase\Service</code>, 
welche das Model und damit die eigentliche Funktionalität enthalten.
</p>

<figure>
<img src="images/Klassendiagramm.png" class="inline">
<figcaption>
Klassendiagramm Homebase\Service
</figcaption>
</figure>

<h3>Laufzeitsicht</h3>

<p>
Neben der Web-Oberfläche zur Konfiguration der Anwendung ist hauptsächlich die 
Engine, welche die automatische Steuerung der Lampen übernimmt, dynamisch.
Die Funktionsweise der Engine wird in diesem Kapitel beschrieben.
</p>

<p>
</p>

<figure>
<img src="images/Sequenzdiagramm App.png" class="inline">
<figcaption>
Sequenzdiagramm App
</figcaption>
</figure>

<figure>
<img src="images/Sequenzdiagramm Cron.png" class="inline">
<figcaption>
Sequenzdiagramm Engine
</figcaption>
</figure>


<h3 class="break">Verteilungssicht</h3>

<p>
Die Web-Applikation wird zusammen mit dem Datenbank-Schema auf dem gleichen 
Server deployed. Das Deployment ist über einen Continious-Integration-Server 
automatisiert.
</p>

<p>
Die iPhone-App wird manuell mit einem USB-Kabel auf dem iPhone installiert.
</p>

<figure>
<img src="images/Verteilungsdiagramm.png" class="inline">
<figcaption>Verteilungsdiagramm</figcaption>
</figure>

<h3 class="break">Datenmodell</h3>

<p>
Sämtliche Informationen der Anwendung werden in einer MySQL-Datenbank gespeichert.
Das nachfolgende relationale Datenmodell zeigt die Entitäten sowie deren Beziehungen.
</p>

<figure>
<img src="images/erm.png">
<figcaption>
Datenmodell
</figcaption>
</figure>

<p class="break">
In der folgenden Tabelle finden sich zu jeder Tabelle eine kurze Beschreibung des
Inhalts resp. des Zwecks der Tabelle.
</p>

<figure>
<table class="table-extended inline" width="100%">
<tr><th>Tabelle</th><th>Inhalt</th></tr>
<tr><td>beacons</td><td>Sämtliche vom Benutzer erfassten Beacons</td></tr>
<tr><td>beacons_proximities</td><td>Die von der iPhone-App gemessenen Abstände</td></tr>
<tr><td>beacons_states</td><td>Die von der iPhone-App gemeldeten Positionen des Benutzers</td></tr>
<tr><td>beacons_mappings</td><td>Zuweisungen der Beacons zu den Lampen</td></tr>
<tr><td>lights</td><td>Die über die hue API gefundenen Lampen</td></tr>
<tr><td>lights_actions</td><td>Durchgeführte und geplannte Interaktionen mit der hue API zum An- oder Ausschalten der Lampen</td></tr>
<tr><td>lights_log</td><td>Historische Daten über die Brenndauer der Lampen</td></tr>
<tr><td>oauth_clients</td><td>OAuth 2.0 Client-Applikationen (iPhone-Apps)</td></tr>
<tr><td>oauth_tokens</td><td>Authorisierte OAuth-Tokens für die iPhone-App</td></tr>
<tr><td>config</td><td>Systemeinstellungen</td></tr>
</table>
<figcaption>
Tabellen Datenmodell
</figcaption>
</figure>

<h3>Benutzeroberfläche</h3>

<p>
Die Benutzeroberfläche der Web-Applikation wurde mit 
<a href="#ref-bootstrap" class="ref">Bootstrap</a> umgesetzt. Diese 
Bibliothek ermöglicht unter anderem, dass die Web-Applikation auch auf mobilen 
Geräten einfach zu bedienen ist.
</p>

<p>
Das Dashboard hat neben den Events und der Schaltfläche zum pausieren der Engine
auch einige statistische Informationen, wie die Anzahl and (aktiven) Beacons,
die Anzahl an (leuchtenden) Lampen sowie ein Diagram zur Nutzung der Lichter 
während der letzten 3 Wochen (dargestellt als Streamgraph).
</p>

<figure>
<img src="images/Screenshot-Dashboard.png" class="inline">
<figcaption>
Screenshot Dashboard
</figcaption>
</figure>

<p>
Der Report zeigt die Nutzung der Lichter während der letzten 3 Tage in einem 
Ringdiagramm. Die Darstellung wurde mit 
<a href="#ref-d3" class="ref">D3.js</a>, einer Bibliothek zur 
Erstellung von Datenvisualisierungen, erstellt. Das Diagramm zeigt, zu welchen
Uhrzeiten wieviele Lichter aktiv waren.
</p>

<figure>
<img src="images/Screenshot-Report.png" class="inline">
<figcaption>
Screenshot Report
</figcaption>
</figure>

<p class="break">
Auf der Seite für das Setup werden die Beacons und derren Zuweisung zu den 
Lichtern angezeigt und können bearbeitet werden.
</p>

<figure>
<img src="images/Screenshot-Setup.png" class="inline">
<figcaption>
Screenshot Setup
</figcaption>
</figure>

<p>
Bearbeitet der Benutzer ein Beacon, kann er dessen Namen sowie seine 
Identifikationsmerkmale ändern.
</p>

<figure>
<img src="images/Screenshot-Beacon.png" class="inline">
<figcaption>
Screenshot Beacon bearbeiten
</figcaption>
</figure>

<!--

<h3>TODO Entwurfsentscheidungen</h3>

<h4>Laufumgebung Engine</h4>

<p>
PHP vs. Objective-C
Internetverbindung
Verteilung
</p>

-->

</div>

<div class="chapter">
<h2>Fazit</h2>

<p>
Die Heimautomatisierung mit iBeacons ist durchaus möglich, muss aber detailiert 
geplant sein. Aufgrund der technischen Einschränkungen in iOS ist eine 
fortlaufende Messung der Distanz zu einem iBeacon nicht möglich, die Position 
des Bewohners muss deshalb über das Betreten und Verlassen des Empfangsbereichs 
des iPhones realisiert werden.
</p>

<p>
Die von Apple gesetzten Einschränkungen machen jedoch Sinn, da sie den Akku des 
iPhones schonen und einen übermässigen Energieverbrauch aufgrund einer 
Hintergrundaktivität verhindern. Insofern wäre es wohl auch empfehlenswert eine 
ähnliche Implementierung auf anderen Plattformen anzuwenden.
</p>

<p>
Aufgrund dieser Vorraussetzungen ist es notwendig, die Signalstärke der Beacons
auf ca. 3-5 Meter (-20 dBm) zu reduzieren. Die daraus resultierende Signalstärke 
ist auch aufgrund des Energieverbrauchs der Esimote Beacons empfehlenswert.
Dadurch werden je nach Grösse des Raums mehrere Beacons pro Raum notwendig.
Die im Projekt eingesetzte Anzahl von drei Beacons war eher knapp. Pro Raum 
sind drei bis vier Beacons zu empfehlen.
</p>

<p>
Für die Software gibt es bereits mehrere Ideen für eine Weiterentwicklung. Zum 
einen wäre es für Haushalte mit mehreren Personen sinnvoll, wenn die Anwendung 
auch mehrbenutzerfähig ist. In der Web-Applikation könnte die Visualisierung der 
stattgefundenen Events noch verbessert und die Funktionalität zur manuellen 
Steuerung der Beleuchtung eingebaut werden. Eine hilfreiche Funktion wäre auch 
die Warnung des Benutzers, falls die Batterie eines Beacons fast leer ist.
Zudem wäre ein regelmässiger Abgleich des effektiven Lichtstatus mit der von 
der Engine definierten
</p>

<p>
Der Umstand, dass die Lichter weiterhin über die normalen Lichtschalter 
gesteuert werden können, hat einen positiven und einen negativen Aspekt. Es
ist praktisch, wenn die Lichter über die Nacht manuell komplett ausgeschaltet 
werden können. Sobald man die Lichter jedoch manuell ausschaltet, können diese 
nicht mehr automatisch angeschaltet werden. Während dem Projekt wurden aus 
Gewohnheit die Lichter beim Verlassen der Wohnung oft manuell abgeschaltet und 
gingen dann beim erneuten Betreten der Wohnung nicht wieder an. Die teilweise 
auftretende Verzögerung beim automatischen Einschalten des Licht in einem 
kleinen führte auch oft dazu, dass automatisch der Lichtschalter betätigt wurde, 
das Licht somit vom Strom getrennt war und nicht mehr automatisch angeschaltet 
werden konnte.
</p>

</div>

<div class="chapter">
<h2>Anhang</h2>

<h3>Software</h3>

<p>
Die während der Arbeit verwendete Software wird hier der Vollständigkeitshalber 
dokumentiert.
</p>

<ul>
<li>Mac OS X 10.9 Build 13A603</li>
<li>iOS 7.1.1 Build 11D201</li>
<li>Xcode 5.0.2 Build 5A3005</li>
<li>Bluetooth Explorer 4.2.0 Build 4.2.0f2</li>
<li>PacketLogger 4.2.0 Build 4.2.0f2</li>
<li>Prince 9.0 rev 4</li>
<li>MySQL Workbench 6.0 Build 6.0.7.11216</li>
<li>MySQL 5.1.70</li>
<li>PHP 5.4.26</li>
<li>Silex 1.1.2</li>
<li>PHPUnit 3.7.31</li>
<li>Twig 1.15.1</li>
<li>Sweet Home 3D 4.3</li>
<li>Git 1.8.5.2</li>
<li>Tower 1.5.4</li>
<li>Bootstrap 3.1.0</li>
<li>jQuery 1.9.1</li>
<li>D3.js 3.4.1</li>
</ul>


<h3 class="break">Quellenverzeichnis</h3>

<p id="ref-understading-ibeacon" class="reference-item">
    <span class="ref">Apple Inc. (2013): iOS: Understanding iBeacon</span>. 4. Dezember 2013.
    <a href="http://support.apple.com/kb/HT6048">http://support.apple.com/kb/HT6048</a>
    (abgerufen&nbsp;am&nbsp;19. April&nbsp;2014)
</p>

<p id="ref-bluetooth-smart" class="reference-item">
    <span class="ref">Bluetooth SIG, Inc. (2013): Bluetooth Smart</span>
    <a href="http://www.bluetooth.com/Pages/Bluetooth-Smart.aspx">http://www.bluetooth.com/Pages/Bluetooth-Smart.aspx</a>
    (abgerufen&nbsp;am&nbsp;19. April&nbsp;2014)
</p>

<p id="ref-company-identifiers" class="reference-item">
    <span class="ref">Bluetooth SIG, Inc. (2014): Company Identifiers</span>
    <a href="https://www.bluetooth.org/en-us/specification/assigned-numbers/company-identifiers">https://www.bluetooth.org/en-us/specification/assigned-numbers/company-identifiers</a>
    (abgerufen&nbsp;am&nbsp;21. April&nbsp;2014)
</p>

<p id="ref-estimote-beacons" class="reference-item">
    <span class="ref">Estimote, Inc. (2013): Estimote Beacons</span>
    <a href="http://estimote.com/">http://estimote.com/</a>
    (abgerufen&nbsp;am&nbsp;4. Mai&nbsp;2014)
</p>

<p id="ref-lightblue" class="reference-item">
    <span class="ref">Punch Through Design LLC (2013): LightBlue - Bluetooth Low Energy</span>. Version 1.50.
    <a href="https://itunes.apple.com/ch/app/lightblue-bluetooth-low-energy/id557428110?l=en&mt=8">https://itunes.apple.com/ch/app/lightblue-bluetooth-low-energy/id557428110?l=en&mt=8</a>
    (abgerufen&nbsp;am&nbsp;20. April&nbsp;2014)
</p>

<p id="ref-silex" class="reference-item">
    <span class="ref">Sensio Labs (2013): Silex</span>
    <a href="http://silex.sensiolabs.org/">http://silex.sensiolabs.org/</a>
    (abgerufen&nbsp;am&nbsp;4. Mai&nbsp;2014)
</p>

<p id="ref-twig" class="reference-item">
    <span class="ref">Sensio Labs (2014): Twig</span>
    <a href="http://twig.sensiolabs.org/">http://twig.sensiolabs.org/</a>
    (abgerufen&nbsp;am&nbsp;4. Mai&nbsp;2014)
</p>

<p id="ref-bootstrap" class="reference-item">
    <span class="ref">Mark Otto (2013): Bootstrap</span>
    <a href="http://getbootstrap.com/">http://getbootstrap.com/</a>
    (abgerufen&nbsp;am&nbsp;7. Mai&nbsp;2014)
</p>

<p id="ref-d3" class="reference-item">
    <span class="ref">Mike Bostock (2013): D3.js</span>
    <a href="http://d3js.org/">http://d3js.org/</a>
    (abgerufen&nbsp;am&nbsp;7. Mai&nbsp;2014)
</p>

<p id="ref-sweet-home-3d" class="reference-item">
    <span class="ref">eTeks (2014): Sweet Home 3D</span>
    <a href="http://www.sweethome3d.com/">http://www.sweethome3d.com/</a>
    (abgerufen&nbsp;am&nbsp;7. Mai&nbsp;2014)
</p>

<p id="ref-chipolo" class="reference-item">
    <span class="ref">Geatronik d.o.o. (2014): Chipolo</span>
    <a href="http://www.chipolo.net/">http://www.chipolo.net/</a>
    (abgerufen&nbsp;am&nbsp;10. Mai&nbsp;2014)
</p>

<p id="ref-hardware-io-tools" class="reference-item">
    <span class="ref">Apple Inc. (2013): Hardware IO Tools for Xcode</span>. Veröffentlicht am 22. Oktober 2013.
    <a href="https://developer.apple.com/downloads/index.action?name=hardware%20io">https://developer.apple.com/downloads/index.action?name=hardware%20io</a>
    (abgerufen&nbsp;am&nbsp;20. April&nbsp;2014)
</p>

<p id="ref-bluetooth-spec" class="reference-item">
    <span class="ref">Bluetooth SIG, Inc. (2010): Bluetooth Specification Version 4.0</span>
    <a href="https://www.bluetooth.org/docman/handlers/downloaddoc.ashx?doc_id=229737">https://www.bluetooth.org/docman/handlers/downloaddoc.ashx?doc_id=229737</a>
    (abgerufen&nbsp;am&nbsp;22. November&nbsp;2013)
</p>

<p id="ref-supplement-bluetooth" class="reference-item">
    <span>Bluetooth SIG, Inc. (2012): Supplement to Bluetooth Core Specification</span>. Version 2.
    <a href="https://www.bluetooth.org/docman/handlers/downloaddoc.ashx?doc_id=260933">https://www.bluetooth.org/docman/handlers/downloaddoc.ashx?doc_id=260933</a>
    (abgerufen&nbsp;am&nbsp;22. November&nbsp;2013)
</p>

<p id="ref-health-thermometer" class="reference-item">
    <span>Apple Inc. (2011): CoreBluetooth: Health Thermometer</span>. Version 1.0.
    <a href="https://developer.apple.com/library/mac/samplecode/HealthThermometer/Introduction/Intro.html#//apple_ref/doc/uid/DTS40011370">https://developer.apple.com/library/mac/samplecode/HealthThermometer/Introduction/Intro.html#//apple_ref/doc/uid/DTS40011370</a> 
    (abgerufen&nbsp;am&nbsp;20.&nbsp;November&nbsp;2013)
</p>

<p id="ref-location-programming-guide" class="reference-item">
    <span class="ref">Apple Inc. (2013): Location and Maps Programming Guide</span>
    <a href="https://developer.apple.com/library/ios/documentation/UserExperience/Conceptual/LocationAwarenessPG/Introduction/Introduction.html#//apple_ref/doc/uid/TP40009497">https://developer.apple.com/library/ios/documentation/UserExperience/Conceptual/LocationAwarenessPG/Introduction/Introduction.html#//apple_ref/doc/uid/TP40009497</a>
    (abgerufen&nbsp;am&nbsp;24.&nbsp;November&nbsp;2013)
</p>

<p id="ref-bluetooth-programming-guide" class="reference-item">
    <span class="ref">Apple Inc. (2013): Core Bluetooth Programming Guide</span>. 18. September 2013.
    <a href="https://developer.apple.com/library/ios/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/CoreBluetooth_concepts.pdf">https://developer.apple.com/library/ios/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/CoreBluetooth_concepts.pdf</a>
    (abgerufen&nbsp;am&nbsp;20.&nbsp;November&nbsp;2013)
</p>

<p id="ref-beacon-emitter" class="reference-item">
    Laurent Gaches (2013): BeaconEmitter.
    <a href="https://github.com/lgaches/BeaconEmitter">https://github.com/lgaches/BeaconEmitter</a> 
    (abgerufen&nbsp;am&nbsp;20.&nbsp;November&nbsp;2013)
</p>


<h3 class="break">Abbildungsverzeichnis</h3>

<ul id="figures"></ul>


<h3 class="break">Glossar</h3>

<p>
Beacon: Ein elektronisches Bauteil, das ein iBeacon-Signal aussendet.
</p>
<p>
RSSI: Received Signal Strength Indicator, gibt die empfange Stärke eines Signals an.
</p>
<p>
Continious-Integration: Automatisiertes Testen von Software in regelmässigen Abständen.
</p>
<p>
Deployment: Das Verschieben oder Aktualisieren von Software auf die Ziellaufzeitumgebung.
</p>
<p>
Template-Engine: Interpretiert einen einfachen Syntax im HTML-Code und 
verbindet diesen mit Daten zu einer fertigen HTML-Seite.
</p>
<p>
API: Application Programming Interface, bezeichnet die Schnittstelle, über
welche der Client Daten vom Server abruft.
</p>
<p>
Client: Ein Anwendungsprogramm, welches auf dem Gerät des Benutzers läuft und
meist mit einem Server kommuniziert.
</p>
<p>
REST: Representational State Transfer, ist eine Architektur für eine API, welche
die nach HTTP definierten Regeln befolgt.
</p>
<p>
Bundle: Zusammenfassung mehrerer Klassen und Konfigurationsdateien innerhalb
eines Symfony-PHP-Projekts.
</p>
<p>
HTTP: Hypertext Transfer Protocol, ist ein Protokoll zur Übertragung von Daten
über ein Netzwerk.
</p>
<p>
HTTP-Header: Feld einer HTTP-Übertragung, welches zusammen mit den Daten im HTTP-
Protokoll übertragen wird.
</p>
<p>
JSON: JavaScript Object Notation, ist ein kompaktes, lesbares Datenformat,
welches oft im Internet verwendet wird.
</p>
<p>
XML: Extensible Markup Language, ist ebenfalls ein Datenformat, welches oft
im Internet Verwendung findet, jedoch mächtiger ist als JSON.
</p>
<p>
Desktop: Computer, welche von einem Benutzer bedient meist an einem Schreibtisch
bedient wird.
</p>
<p>
Browser: Software zur Darstellung von Websiten aus dem Internet. Beispielsweise
Google Chrome oder Mozilla Firefox.
</p>
<p>
URL: Uniform Resource Locator, eine Internet-Adresse welche auf eine Ressource
wie z.B. eine Website zeigt.
</p>
<p>
Code Coverage: Beschreibt, wie viel Prozent des Source-Codes durch Unit Tests
abgedeckt werden.
</p>
<p>
iOS: Betriebssystem von Apple für Handys und Tablets (iPhone und iPad).
</p>
<p>
Micro-Framework: Bezeichnet eine Mischung ein Framework mit reduzierter Funktionalität,
welche eher wie eine Bibliothek aufgebaut ist.
</p>
</div>

<footer>&#160;</footer>

</body>
</html>
